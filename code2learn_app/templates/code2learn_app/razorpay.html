
{% load static %}

    <link href="{% static 'code2learn_app/images/version7/navbar/Favicon.png' %}" rel="icon">

    <script src="https://code.jquery.com/jquery-3.5.1.js"
        integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<div class="container mt-5 pt-5" style="min-height:90vh;">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
    var options = {
        "key": "{{rzp_id}}", // Enter the Key ID generated from the Dashboard
        "amount": "{{payment.amount}}", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
        "currency": "INR",
        "name": "code2learn",
        "description": "Course Transaction",
        "image": "{% static 'code2learn_app/images/version7/footer/logo.svg' %}",
        "order_id": "{{payment.id}}", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
        "handler": function (response){
            $.ajax({
                url:  "{% url 'razorHandleRequest' %}",
              type: 'POST',
              data: {
                server_order: '{{payment.id}}',
                payment_id: response.razorpay_payment_id,
                order_id: response.razorpay_order_id,
                sign: response.razorpay_signature,
              },
              success: function(data){
                  var v = data;
                  if (data.success == true){
                      Swal.fire({
                        icon: 'success',
                        title: 'Hurray...!',
                        text: 'Payment Success!',
                        });
                      window.location.replace("{% url 'show_invoice' payment.id %}");
                  }
                  else{
                      Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Something went wrong!',
                        footer: '<a href="{% url "home" %}">Return to Homepage</a>'
                        });
                      window.location.replace('/register');

                  }
              },
            });
        },
        "modal": {
            "ondismiss": function(){
                console.log('Checkout form closed');
                window.location.replace('/register');
        }
    },
        "prefill": {
            "name": "{{name}}",
            "email": "{{email}}",
            "contact": "{{phone_num}}"
        },
        "notes": {
            "address": "code2learn office"
        },
        "theme": {
            "color": "#58579E"
        }

    };
    var rzp1 = new Razorpay(options);
    rzp1.on('payment.failed', function (response){
        $.ajax({
            url:  "{% url 'failed_payment' %}",
          type: 'POST',
          data: {
            server_order: '{{payment.id}}',
            payment_id: response.error.metadata.payment_id,
            order_id: response.error.metadata.order_id,
            reason: response.error.reason,
            step: response.error.step,
            source: response.error.source,
            description: response.error.description,
            code: response.error.code,

          },
          success: function(data){
              var v = data;
              if (data.success == true){
                  Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Payment failed',
                        footer: '<a href="{% url "home" %}">Return to Homepage</a>'
                        });
                  window.location.replace('/');
              }
              else{
                  Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Payment was unsuccessful!',
                        footer: '<a href="{% url "register" %}">Return to Registration Page</a>'
                        });
                  window.location.replace('/register');
              }
          },
        });
    });
    window.addEventListener('load', function(e) {
        rzp1.open();
        e.preventDefault();
    });
    </script>
</div>
